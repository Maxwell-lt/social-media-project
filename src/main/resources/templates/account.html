<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet" type="text/css">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js" type="text/javascript"></script>
    <meta th:content="${_csrf.token}" th:name="_csrf"/>
    <title th:text="${pageuser.username} + '\'s Account'">Account</title>
</head>
<body>
<div th:replace="header :: header"></div>
<div class="container">
    <div class="row">
        <div class="col-md-6">
            <h1 class="text-light" th:text="${pageuser.username} + '\'s Account'"></h1>
        </div>
        <div class="col-md-6" th:if="${mypage == true}">
            <div id="alertContainer"></div>
            <div class="form-group">
                <label for="username">New Username</label><input id="username" type="text">
                <button class="btn btn-primary" id="changeUsername" type="button">Update username</button>
            </div>
            <div class="form-group">
                <label for="email">New email</label><input id="email" type="text">
                <button class="btn btn-primary" id="changeEmail" type="button">Update Email</button>
            </div>
            <div class="form-group">
                <label for="oldpassword">Current Password</label><input id="oldpassword" type="password">
                <label for="newpassword">New Password</label><input id="newpassword" type="password">
                <button class="btn btn-primary" id="changePassword" type="button">Update password</button>
            </div>
            <script type="text/javascript">
                const token = document.getElementsByTagName('meta')["_csrf"].content;

                function createAlert(success, text) {
                    var alertClass = success ? "alert-success" : "alert-danger";
                    document.getElementById("alertContainer").innerHTML = '<div class="alert ' + alertClass + '" role="alert">' + text + '</div>'
                }

                document.getElementById("changeUsername").onclick = (evt) => {
                    let xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (this.readyState === 4 && this.status === 200) {
                            let response = JSON.parse(this.responseText);
                            if (response.success) {
                                createAlert(true, "Updated username!");
                            } else {
                                createAlert(false, "Username update failed.");
                            }
                        }

                        xhr.open("PUT", "/account/username", true);
                        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
                        xhr.send("_csrf=" + token +
                            "&username=" + document.getElementById("username").innerText);
                    };
                };

                document.getElementById("changeEmail").onclick = (evt) => {
                    let xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (this.readyState === 4 && this.status === 200) {
                            let response = JSON.parse(this.responseText);
                            if (response.success) {
                                createAlert(true, "Updated email!");
                            } else {
                                createAlert(false, "Email update failed.");
                            }
                        }

                        xhr.open("PUT", "/account/email", true);
                        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
                        xhr.send("_csrf=" + token +
                            "&email=" + document.getElementById("email").innerText);
                    };
                };

                document.getElementById("changePassword").onclick = (evt) => {
                    let xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (this.readyState === 4 && this.status === 200) {
                            let response = JSON.parse(this.responseText);
                            if (response.success) {
                                createAlert(true, "Updated password!");
                            } else {
                                createAlert(false, "Password update failed.");
                            }
                        }

                        xhr.open("PUT", "/account/password", true);
                        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
                        xhr.send("_csrf=" + token +
                            "&oldpass=" + document.getElementById("oldpassword").innerText +
                            "&newpass=" + document.getElementById("newpassword").innerText);
                    };
                };
            </script>
        </div>
    </div>

    <ul th:replace="navfragment :: displayOptions(true)"></ul>
    <div th:replace="postfragment :: posts(${posts}, ${totallikes}, ${mylikes})"></div>
    <div th:replace="navfragment :: pageNavigation(${posts}, ${pagenumbers})"></div>
</div>
<div th:replace="likefragment :: purchaselikesmodal"></div>
<script th:replace="likefragment :: likescript"></script>
</body>
</html>
